#!/bin/bash

stage="$1"
destination="$2"
arch="$3"

#Include our common functions
. ./packages/common/functions

echo "Cross-Compiling Pi-Kernel for $arch at $destination - stage: $stage"

download_dir="$destination/packages"
destination_dir="$destination/dist"
cross_tools="$4"

cd $download_dir
if [ ! -d "pikernel" ]; then
  #git clone -b rpi-4.4.y https://github.com/raspberrypi/linux.git pikernel
  git clone -b rpi-4.7.y https://github.com/raspberrypi/linux.git pikernel
fi

cd "$download_dir/pikernel"
if [ -f "done-$stage.lock" ]; then
  echo "Already done. Skiping..."
  exit 0
fi

macro_target=$(get_macro_target_for_arch $arch)
target=$(get_target_for_arch $arch)
prefix=$(get_prefix_for_arch $arch)

if [ "x$macro_target" == "xarm" ]; then
  config="bcm2709_defconfig"
else
  echo "Unsupported macro target"
fi

if [ "x$stage" == "xheaders" ]; then
  export PATH=$PATH:$destination/dist/bin
  export KERNEL=kernel7
  make distclean
  make ARCH=$macro_target CROSS_COMPILE=$prefix- $config
  make ARCH=$macro_target CROSS_COMPILE=$prefix- INSTALL_HDR_PATH=$destination_dir/ headers_install
elif [ "x$stage" == "xfull" ]; then
  export PATH=$PATH:$cross_tools/dist/bin
  export KERNEL=kernel7
  make distclean
  echo "make ARCH=$macro_target CROSS_COMPILE=$prefix- $config"
  make ARCH=$macro_target CROSS_COMPILE=$prefix- $config
  echo "make ARCH=$macro_target CROSS_COMPILE=$prefix- INSTALL_HDR_PATH=$destination_dir/ headers_install"
  make ARCH=$macro_target CROSS_COMPILE=$prefix- INSTALL_HDR_PATH=$destination_dir/ headers_install
  echo "make ARCH=$macro_target CROSS_COMPILE=$prefix- zImage modules dtbs"
  make ARCH=$macro_target CROSS_COMPILE=$prefix- zImage modules dtbs
  echo "make ARCH=$macro_target CROSS_COMPILE=$prefix- modules_install"
  make ARCH=$macro_target CROSS_COMPILE=$prefix- INSTALL_MOD_PATH=$destination_dir modules_install

  sudo mkdir -p $destination_dir/boot/overlays/

  sudo cp arch/arm/boot/dts/*.dtb $destination_dir/boot/
  sudo cp arch/arm/boot/dts/overlays/*.dtb* $destination_dir/boot/overlays/
  sudo cp arch/arm/boot/dts/overlays/README $destination_dir/boot/overlays/
  sudo scripts/mkknlimg arch/arm/boot/zImage $destination_dir/boot/$KERNEL.img
  sudo cp -Rf $current_dir/config/boot/* $destination_dir/boot/
fi

touch "done-$stage.lock"
